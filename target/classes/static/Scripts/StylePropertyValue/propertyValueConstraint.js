var constraintConfig = [{ "PropertyID": 425, "PropertyName": "进气型式", "PropertyValue": "自然吸气", "CheckPropertyID": 408, "CheckPropertyName": "增压方式", "CheckPropertyValue": "无,请选择" }, { "PropertyID": 425, "PropertyName": "进气型式", "PropertyValue": "增压", "CheckPropertyID": 408, "CheckPropertyName": "增压方式", "CheckPropertyValue": "涡轮增压,双涡轮增压,机械增压,涡轮机械双增压,请选择" }, { "PropertyID": 408, "PropertyName": "增压方式", "PropertyValue": "涡轮增压", "CheckPropertyID": 425, "CheckPropertyName": "进气型式", "CheckPropertyValue": "增压" }, { "PropertyID": 408, "PropertyName": "增压方式", "PropertyValue": "双涡轮增压", "CheckPropertyID": 425, "CheckPropertyName": "进气型式", "CheckPropertyValue": "增压" }, { "PropertyID": 408, "PropertyName": "增压方式", "PropertyValue": "机械增压", "CheckPropertyID": 425, "CheckPropertyName": "进气型式", "CheckPropertyValue": "增压" }, { "PropertyID": 408, "PropertyName": "增压方式", "PropertyValue": "涡轮机械双增压", "CheckPropertyID": 425, "CheckPropertyName": "进气型式", "CheckPropertyValue": "增压" }, { "PropertyID": 408, "PropertyName": "增压方式", "PropertyValue": "无", "CheckPropertyID": 425, "CheckPropertyName": "进气型式", "CheckPropertyValue": "自然吸气,请选择" }, { "PropertyID": 510, "PropertyName": "DVD", "PropertyValue": "有", "CheckPropertyID": 488, "CheckPropertyName": "中控台液晶屏", "CheckPropertyValue": "有,分屏显示" }, { "PropertyID": 703, "PropertyName": "倒车影像", "PropertyValue": "有", "CheckPropertyID": 488, "CheckPropertyName": "中控台液晶屏", "CheckPropertyValue": "有,分屏显示" }, { "PropertyID": 488, "PropertyName": "中控台液晶屏", "PropertyValue": "无", "CheckPropertyID": 510, "CheckPropertyName": "DVD", "CheckPropertyValue": "无,请选择" }, { "PropertyID": 488, "PropertyName": "中控台液晶屏", "PropertyValue": "无", "CheckPropertyID": 703, "CheckPropertyName": "倒车影像", "CheckPropertyValue": "无,请选择" }, { "PropertyID": 527, "PropertyName": "多功能方向盘功能", "PropertyValue": "音响调节", "CheckPropertyID": 528, "CheckPropertyName": "多功能方向盘", "CheckPropertyValue": "有" }, { "PropertyID": 527, "PropertyName": "多功能方向盘功能", "PropertyValue": "定速巡航", "CheckPropertyID": 528, "CheckPropertyName": "多功能方向盘", "CheckPropertyValue": "有" }, { "PropertyID": 527, "PropertyName": "多功能方向盘功能", "PropertyValue": "蓝牙", "CheckPropertyID": 528, "CheckPropertyName": "多功能方向盘", "CheckPropertyValue": "有" }, { "PropertyID": 527, "PropertyName": "多功能方向盘功能", "PropertyValue": "定速巡航", "CheckPropertyID": 545, "CheckPropertyName": "定速巡航", "CheckPropertyValue": "有" }, { "PropertyID": 527, "PropertyName": "多功能方向盘功能", "PropertyValue": "蓝牙", "CheckPropertyID": 479, "CheckPropertyName": "蓝牙系统", "CheckPropertyValue": "有" }, { "PropertyID": 578, "PropertyName": "燃料类型", "PropertyValue": "汽油", "CheckPropertyID": 577, "CheckPropertyName": "燃油标号", "CheckPropertyValue": "待查,90号,93号,97号,98号及以上,请选择" }, { "PropertyID": 578, "PropertyName": "燃料类型", "PropertyValue": "柴油", "CheckPropertyID": 577, "CheckPropertyName": "燃油标号", "CheckPropertyValue": "待查,柴油,请选择" }, { "PropertyID": 578, "PropertyName": "燃料类型", "PropertyValue": "油电混合动力", "CheckPropertyID": 577, "CheckPropertyName": "燃油标号", "CheckPropertyValue": "待查,90号,93号,97号,98号及以上,请选择" }, { "PropertyID": 578, "PropertyName": "燃料类型", "PropertyValue": "油气混合动力", "CheckPropertyID": 577, "CheckPropertyName": "燃油标号", "CheckPropertyValue": "待查,90号,93号,97号,98号及以上,请选择" }, { "PropertyID": 578, "PropertyName": "燃料类型", "PropertyValue": "电力", "CheckPropertyID": 577, "CheckPropertyName": "燃油标号", "CheckPropertyValue": "待查,请选择" }, { "PropertyID": 578, "PropertyName": "燃料类型", "PropertyValue": "LPG", "CheckPropertyID": 577, "CheckPropertyName": "燃油标号", "CheckPropertyValue": "待查,请选择" }, { "PropertyID": 578, "PropertyName": "燃料类型", "PropertyValue": "CNG", "CheckPropertyID": 577, "CheckPropertyName": "燃油标号", "CheckPropertyValue": "待查,请选择" }, { "PropertyID": 577, "PropertyName": "燃油标号", "PropertyValue": "90号", "CheckPropertyID": 578, "CheckPropertyName": "燃料类型", "CheckPropertyValue": "汽油,油电混合动力,油气混合动力" }, { "PropertyID": 577, "PropertyName": "燃油标号", "PropertyValue": "93号", "CheckPropertyID": 578, "CheckPropertyName": "燃料类型", "CheckPropertyValue": "汽油,油电混合动力,油气混合动力" }, { "PropertyID": 577, "PropertyName": "燃油标号", "PropertyValue": "97号", "CheckPropertyID": 578, "CheckPropertyName": "燃料类型", "CheckPropertyValue": "汽油,油电混合动力,油气混合动力" }, { "PropertyID": 577, "PropertyName": "燃油标号", "PropertyValue": "98号及以上", "CheckPropertyID": 578, "CheckPropertyName": "燃料类型", "CheckPropertyValue": "汽油,油电混合动力,油气混合动力" }, { "PropertyID": 577, "PropertyName": "燃油标号", "PropertyValue": "柴油", "CheckPropertyID": 578, "CheckPropertyName": "燃料类型", "CheckPropertyValue": "柴油" }, { "PropertyID": 623, "PropertyName": "外后视镜电动折叠功能", "PropertyValue": "有", "CheckPropertyID": 622, "CheckPropertyName": "外后视镜电动调节", "CheckPropertyValue": "有" }, { "PropertyID": 625, "PropertyName": "外后视镜记忆功能", "PropertyValue": "有", "CheckPropertyID": 622, "CheckPropertyName": "外后视镜电动调节", "CheckPropertyValue": "有" }, { "PropertyID": 622, "PropertyName": "外后视镜电动调节", "PropertyValue": "无", "CheckPropertyID": 623, "CheckPropertyName": "外后视镜电动折叠功能", "CheckPropertyValue": "无,请选择" }, { "PropertyID": 622, "PropertyName": "外后视镜电动调节", "PropertyValue": "无", "CheckPropertyID": 625, "CheckPropertyName": "外后视镜记忆功能", "CheckPropertyValue": "无,请选择" }, { "PropertyID": 707, "PropertyName": "备胎类型", "PropertyValue": "全尺寸", "CheckPropertyID": 706, "CheckPropertyName": "备胎位置", "CheckPropertyValue": "底盘悬吊,行李箱盖悬吊,车内,车顶,请选择" }, { "PropertyID": 707, "PropertyName": "备胎类型", "PropertyValue": "非全尺寸", "CheckPropertyID": 706, "CheckPropertyName": "备胎位置", "CheckPropertyValue": "底盘悬吊,行李箱盖悬吊,车内,车顶,请选择" }, { "PropertyID": 706, "PropertyName": "备胎位置", "PropertyValue": "底盘悬吊", "CheckPropertyID": 707, "CheckPropertyName": "备胎类型", "CheckPropertyValue": "全尺寸,非全尺寸,待查" }, { "PropertyID": 706, "PropertyName": "备胎位置", "PropertyValue": "行李箱盖悬吊", "CheckPropertyID": 707, "CheckPropertyName": "备胎类型", "CheckPropertyValue": "全尺寸,非全尺寸,待查" }, { "PropertyID": 706, "PropertyName": "备胎位置", "PropertyValue": "车内", "CheckPropertyID": 707, "CheckPropertyName": "备胎类型", "CheckPropertyValue": "全尺寸,非全尺寸,待查" }, { "PropertyID": 706, "PropertyName": "备胎位置", "PropertyValue": "车顶", "CheckPropertyID": 707, "CheckPropertyName": "备胎类型", "CheckPropertyValue": "全尺寸,非全尺寸,待查" }, { "PropertyID": 730, "PropertyName": "变速箱变速杆位置", "PropertyValue": "方向盘拨片", "CheckPropertyID": 547, "CheckPropertyName": "换档拨片", "CheckPropertyValue": "有" }, { "PropertyID": 547, "PropertyName": "换档拨片", "PropertyValue": "无", "CheckPropertyID": 730, "CheckPropertyName": "变速箱变速杆位置", "CheckPropertyValue": "地排,怀挡,按钮,请选择,待查" }, { "PropertyID": 816, "PropertyName": "自动泊车入位", "PropertyValue": "有", "CheckPropertyID": 800, "CheckPropertyName": "泊车雷达（车前）", "CheckPropertyValue": "有" }, { "PropertyID": 816, "PropertyName": "自动泊车入位", "PropertyValue": "有", "CheckPropertyID": 702, "CheckPropertyName": "倒车雷达（车后）", "CheckPropertyValue": "有" }, { "PropertyID": 800, "PropertyName": "泊车雷达（车前）", "PropertyValue": "无", "CheckPropertyID": 816, "CheckPropertyName": "自动泊车入位", "CheckPropertyValue": "无,请选择" }, { "PropertyID": 702, "PropertyName": "倒车雷达（车后）", "PropertyValue": "无", "CheckPropertyID": 816, "CheckPropertyName": "自动泊车入位", "CheckPropertyValue": "无,请选择" }, { "PropertyID": 573, "PropertyName": "车顶型式", "PropertyValue": "敞篷", "CheckPropertyID": 570, "CheckPropertyName": "车篷型式", "CheckPropertyValue": "软顶,硬顶,软硬双顶,请选择" }, { "PropertyID": 573, "PropertyName": "车顶型式", "PropertyValue": "硬顶", "CheckPropertyID": 570, "CheckPropertyName": "车篷型式", "CheckPropertyValue": "请选择" }, { "PropertyID": 570, "PropertyName": "车篷型式", "PropertyValue": "软顶", "CheckPropertyID": 573, "CheckPropertyName": "车顶型式", "CheckPropertyValue": "敞篷" }, { "PropertyID": 570, "PropertyName": "车篷型式", "PropertyValue": "硬顶", "CheckPropertyID": 573, "CheckPropertyName": "车顶型式", "CheckPropertyValue": "敞篷" }, { "PropertyID": 570, "PropertyName": "车篷型式", "PropertyValue": "软硬双顶", "CheckPropertyID": 573, "CheckPropertyName": "车顶型式", "CheckPropertyValue": "敞篷" }, { "PropertyID": 814, "PropertyName": "空气悬挂", "PropertyValue": "有", "CheckPropertyID": 708, "CheckPropertyName": "可调悬挂", "CheckPropertyValue": "有" }, { "PropertyID": 708, "PropertyName": "可调悬挂", "PropertyValue": "无", "CheckPropertyID": 814, "CheckPropertyName": "空气悬挂", "CheckPropertyValue": "无,请选择" }, { "PropertyID": 616, "PropertyName": "后导流尾翼", "PropertyValue": "有", "CheckPropertyID": 793, "CheckPropertyName": "运动外观套件", "CheckPropertyValue": "有" }, { "PropertyID": 597, "PropertyName": "运动包围", "PropertyValue": "有", "CheckPropertyID": 793, "CheckPropertyName": "运动外观套件", "CheckPropertyValue": "有" }, { "PropertyID": 793, "PropertyName": "运动外观套件", "PropertyValue": "无", "CheckPropertyID": 616, "CheckPropertyName": "后导流尾翼", "CheckPropertyValue": "无,请选择" }, { "PropertyID": 793, "PropertyName": "运动外观套件", "PropertyValue": "无", "CheckPropertyID": 597, "CheckPropertyName": "运动包围", "CheckPropertyValue": "无,请选择" }];


var propertyIds = new Array();

var entityLists = new Array();
//车型属性值约束检查，批量处理下拉框。多选框特殊处理
$(document).ready(function () {
    var j = 0;
    for (var i = 0; i < constraintConfig.length; i++) {
        var entity = constraintConfig[i];
        var a = $.inArray(entity.PropertyID, propertyIds);

        if (a == -1) {
            propertyIds[j] = entity.PropertyID;
            j++;
            //绑定事件
            $("#" + entity.PropertyID).unbind();  //如果之前有绑定过，则移除
            DropDownListChanged(entity.PropertyID);
        }
        entityLists[i] = entity;

        //var propertyID = entity.PropertyID;
        //var propertyName = entity.PropertyName;
        //var propertyValue = entity.PropertyValue;
        //var checkPropertyID = entity.CheckPropertyID;
        //var checkPropertyName = entity.CheckPropertyName;
        //var checkPropertyValue = entity.CheckPropertyValue;

    }

    CheckTeShu();

    bindEventCheck();

});

//绑定控件的事件，约束检查
function bindEventCheck() {
    CheckTruckBox(truckBox_length_min, truckBox_length_max);
    CheckTruckBox(truckBox_width_min, truckBox_width_max);
    CheckTruckBox(truckBox_height_min, truckBox_height_max);
}

function DropDownListChanged(id) {
    $("#" + id).bind("change", function () {
        var valueText = $("#" + id).find("option:selected").text();
        CheckConstraint(id, valueText);
    });
}

function CheckConstraint(propertyId, valueText) {
    var lable = $("#" + propertyId).closest("td").find("label[class='checkConstraintError']");
    if (lable.length > 0) {
        for (var j = 0; j < lable.length; j++) {
            lable[j].remove();
        }
    }
    for (var i = 0; i < entityLists.length; i++) {
        var entity = entityLists[i];

        if (entity.PropertyID == propertyId && valueText == entity.PropertyValue) {
            var checkPropertyId = entity.CheckPropertyID;
            var checkSelectedValue = $("#" + checkPropertyId).find("option:selected").text();
            checkSelectedValue = $.trim(checkSelectedValue);
            var checkPropertyName = entity.CheckPropertyName;
            var checkPropertyValue = entity.CheckPropertyValue;

            if (checkPropertyValue.length > 0) {
                var valueArray = checkPropertyValue.split(',');
                var contains = $.inArray(checkSelectedValue, valueArray);
                if (contains < 0) {

                    var errorText = '<label style="color: red" class="checkConstraintError">与参配"' + checkPropertyName + '"所选值冲突，请检查确认！</label>  ';
                    $("#" + propertyId).closest("td").append(errorText);
                }
            }
        }
    }
    CheckBeConstraint(propertyId);
}

//检查被该属性约束的属性值
function CheckBeConstraint(propertyId) {

    for (var i = 0; i < entityLists.length; i++) {
        var entity = entityLists[i];
        var propertyValueText = $("#" + entity.PropertyID).find("option:selected").text();
        propertyValueText = $.trim(propertyValueText);
        if (entity.CheckPropertyID == propertyId && propertyValueText == entity.PropertyValue) {
            var checkSelectedValue = $("#" + propertyId).find("option:selected").text();
            checkSelectedValue = $.trim(checkSelectedValue);
            var checkPropertyValue = entity.CheckPropertyValue;
            if (checkPropertyValue.length > 0) {
                var valueArray = checkPropertyValue.split(',');
                var contains = $.inArray(checkSelectedValue, valueArray);
                if (contains >= 0) {
                    RemoveErrorLable(entity.PropertyID);
                }
            }
        }
    }
}


//'多功能方向盘功能' '自动泊车入位' 等属性特殊处理 
function CheckTeShu() {
    $("#select_527_0_0_").bind("click", function () {  //音响调节
        RemoveErrorLable('select_527_0_0_');
        var checked = $("#select_527_0_0_").attr("checked") == "checked";
        if (checked) {
            CheckProperty('select_527_0_0_', 528, '多功能方向盘');
        }

    });

    $("#select_527_0_1_").bind("click", function () {  //定速巡航
        RemoveErrorLable('select_527_0_0_');
        var checked = $("#select_527_0_1_").attr("checked") == "checked";
        if (checked) {
            CheckProperty('select_527_0_1_', 528, '多功能方向盘');
            CheckProperty('select_527_0_1_', 545, '定速巡航');
        }

    });

    $("#select_527_0_2_").bind("click", function () {  //蓝牙
        RemoveErrorLable('select_527_0_0_');
        var checked = $("#select_527_0_2_").attr("checked") == "checked";
        if (checked) {

            CheckProperty('select_527_0_2_', 528, '多功能方向盘');
            CheckProperty('select_527_0_2_', 479, '蓝牙系统');
        }

    });

}

function CheckProperty(propertyId, checkPropertyId, checkPropertyName) {
    var checkValue = $("#" + checkPropertyId).find("option:selected").text();
    if (checkValue != '有') {
        var errorText = '<label style="color: red" class="checkConstraintError">与参配"' + checkPropertyName + '"所选值冲突，请检查确认！</label>  ';
        $("#" + propertyId).closest("td").append(errorText);
    }
}

function RemoveErrorLable(propertyId) {
    var lable = $("#" + propertyId).closest("td").find("label[class='checkConstraintError']");
    if (lable.length > 0) {
        for (var i = 0; i < lable.length; i++) {
            lable[i].remove();
        }
    }
}

//卡车，货箱长宽高，若‘最小’未填，则‘最大’禁用（2015-02-12）
var truckBox_length_min = 'txt_965';
var truckBox_length_max = 'txt_966';
var truckBox_width_min = 'txt_967';
var truckBox_width_max = 'txt_970';
var truckBox_height_min = 'txt_968';
var truckBox_height_max = 'txt_969';

function CheckTruckBox(txtId, beCheckTxtId) {
    var minValue = $("#" + txtId).val();
    if (minValue==null) {
        return;  // 校对页，只有前台展示的参配
    }
    if (minValue == "" || minValue.length == 0) {
        $("#" + beCheckTxtId).attr("readonly", "readonly");
    } else {
        $("#" + beCheckTxtId).removeAttr("readonly");
    }
    $("#" + txtId).bind({
        blur: function () {
            var minValue1 = $("#" + txtId).val();
            if (minValue1.length > 0) {
                $("#" + beCheckTxtId).removeAttr("readonly");
            } else {
                $("#" + beCheckTxtId).val("");
                $("#" + beCheckTxtId).attr("value-changed", true);
                $("#" + beCheckTxtId).attr("readonly", "readonly");
            }
        }
    });
}


